<!DOCTYPE html>
<html>
<head>
    <title>Bingo Master Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: #121212;
            color: #ecf0f1;
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* å·¦å´ä¸»æ§å€ */
        .left-panel {
            width: 45%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #333;
            background: #1e1e1e;
        }

        /* å³å´è³‡è¨Šå€ */
        .right-panel {
            width: 55%;
            padding: 20px;
            background: #121212;
            display: flex;
            flex-direction: column;
        }

        /* é ‚éƒ¨è³‡è¨Šåˆ— */
        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #2c2c2c;
            border-radius: 8px;
        }
        .player-count { color: #00e676; font-size: 24px; font-weight: bold; }
        
        /* ç•¶å‰è™Ÿç¢¼å¤§é¡¯ç¤º */
        .number-display {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            border: 5px solid #2980b9;
            border-radius: 20px;
            margin: 10px 0;
            position: relative;
        }
        .big-number {
            font-family: 'Roboto Mono', monospace;
            font-size: 15vw; /* éŸ¿æ‡‰å¼å­—é«” */
            color: #3498db;
            text-shadow: 0 0 20px rgba(52, 152, 219, 0.5);
            margin: 0;
        }

        /* æ§åˆ¶æŒ‰éˆ• */
        .btn-draw {
            padding: 20px;
            font-size: 28px;
            background: linear-gradient(135deg, #2980b9, #3498db);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .btn-draw:disabled { background: #555; color: #aaa; cursor: not-allowed; }
        
        .btn-qr {
            background: #f39c12; border: none; padding: 8px 15px; 
            border-radius: 5px; cursor: pointer; color: white; font-weight: bold;
        }

        /* æ­·å²ç´€éŒ„å€ */
        .history-section {
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid #444;
        }
        .history-title { font-size: 14px; color: #888; margin-bottom: 5px; }
        .history-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            max-height: 100px;
            overflow-y: auto;
        }
        .hist-ball {
            width: 35px; height: 35px;
            background: #333;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 16px; color: #ddd;
            border: 1px solid #555;
        }
        .hist-ball.latest { border-color: #3498db; color: #3498db; font-weight: bold; }

        /* æ’è¡Œæ¦œ */
        .leaderboard-container {
            flex: 1;
            overflow-y: auto;
        }
        .lb-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; margin-bottom: 8px; background: #2c2c2c;
            border-radius: 8px; font-size: 20px;
        }
        .lb-reach { background: #d35400; border-left: 8px solid #e67e22; animation: blink 1s infinite; }
        .lb-bingo { background: #c0392b; color: white; border-left: 8px solid #e74c3c; }
        @keyframes blink { 50% { opacity: 0.8; } }

        /* QR Code å½ˆçª— (ç½®ä¸­æ‡¸æµ®) */
        .modal-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000; /* ä¿è­‰åœ¨æœ€ä¸Šå±¤ */
            justify-content: center; align-items: center;
            flex-direction: column;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 15px; text-align: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.9);
        }
        .close-modal {
            margin-top: 20px; padding: 10px 30px; background: #e74c3c; 
            color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 18px;
        }

        /* éŠæˆ²çµæŸ å…¨è¢å¹•ç‰¹æ•ˆ */
        #game-over-screen {
            display: none; /* JSæ§åˆ¶ */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000; /* æœ€é«˜å±¤ç´š */
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .winner-title { font-size: 50px; color: #f1c40f; margin-bottom: 20px; text-shadow: 0 0 20px #f1c40f; }
        .winner-name { font-size: 80px; color: white; font-weight: bold; animation: pop 0.5s; text-align: center;}
        @keyframes pop { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }

    </style>
</head>
<body>

    <div id="qr-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="qrcode"></div>
            <p style="color:black; margin-top:10px; font-weight:bold;">æƒæåŠ å…¥éŠæˆ²</p>
            <p id="join-url" style="color:#666; font-size:12px;"></p>
            <button class="close-modal" onclick="toggleQR()">é—œé–‰</button>
        </div>
    </div>

    <div id="game-over-screen">
        <div class="winner-title">ğŸ‰ BINGO! æ­å–œä¸­ç ğŸ‰</div>
        <div class="winner-name" id="winner-list">???</div>
        <button class="close-modal" onclick="resetGame()" style="margin-top:50px; background: transparent; border: 2px solid white;">ğŸ”„ é‡ç½®ä¸¦é–‹å§‹æ–°å±€</button>
    </div>

    <div class="left-panel">
        <div class="header-info">
            <button class="btn-qr" onclick="toggleQR()">ğŸ“± é¡¯ç¤º QR Code</button>
            <div style="font-size:14px; color:#aaa;">ç‹€æ…‹: <span id="conn-status" style="color:red">â— æœªé€£ç·š</span></div>
        </div>

        <div class="number-display">
            <h1 class="big-number" id="current-num">--</h1>
        </div>

        <button id="draw-btn" class="btn-draw" onclick="requestDraw()">ğŸ² é–‹ ç</button>

        <div class="history-section">
            <div class="history-title">æ­·å²è™Ÿç¢¼ (ç”±æ–°åˆ°èˆŠ)</div>
            <div class="history-list" id="history-box">
                </div>
        </div>
    </div>

    <div class="right-panel">
        <div class="header-info">
            <span style="font-size:24px; font-weight:bold;">ğŸ† å³æ™‚æˆ°æ³</span>
            <span class="player-count">åœ¨ç·š: <span id="p-count">0</span> äºº</span>
        </div>
        <div class="leaderboard-container" id="leaderboard">
            <div style="text-align:center; color:#555; margin-top:50px;">å°šç„¡æˆ°æ³...</div>
        </div>
    </div>

    <script>
        const socket = io();
        let isRolling = false;
        let rollInterval;

        // é€£ç·šç‹€æ…‹ç›£æ¸¬
        socket.on('connect', () => {
            document.getElementById('conn-status').innerHTML = "â— å·²é€£ç·š";
            document.getElementById('conn-status').style.color = "#00e676";
        });
        socket.on('disconnect', () => {
            document.getElementById('conn-status').innerHTML = "â— æ–·ç·šä¸­";
            document.getElementById('conn-status').style.color = "red";
        });

        // QR Code
        const host = window.location.protocol + "//" + window.location.hostname + (window.location.port ? ':'+window.location.port : '');
        const playUrl = host + "/play";
        document.getElementById('join-url').innerText = playUrl;
        new QRCode(document.getElementById("qrcode"), { text: playUrl, width: 250, height: 250 });

        function toggleQR() {
            const modal = document.getElementById('qr-modal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }

        // è«‹æ±‚é–‹ç (ä¸å†è‡ªå·±ç®—æ•¸å­—ï¼Œæ”¹ç‚ºå«ä¼ºæœå™¨ç®—)
        function requestDraw() {
            if(isRolling) return;
            isRolling = true;
            document.getElementById('draw-btn').disabled = true;
            
            // è¦–è¦ºå‹•ç•« (å‡è£åœ¨è·‘)
            rollInterval = setInterval(() => {
                document.getElementById('current-num').innerText = Math.floor(Math.random() * 75) + 1;
            }, 50);

            // ç™¼é€è«‹æ±‚
            socket.emit('request_draw');
        }

        function resetGame() {
            if(confirm("ç¢ºå®šé‡ç½®éŠæˆ²ï¼Ÿ")) {
                socket.emit('reset_game');
                document.getElementById('game-over-screen').style.display = 'none';
            }
        }

        // --- æ¥æ”¶ä¼ºæœå™¨è¨Šè™Ÿ ---

        // 1. æ”¶åˆ°æ­£å¼è™Ÿç¢¼ (åœæ­¢å‹•ç•«ï¼Œé¡¯ç¤ºçœŸæ•¸å­—)
        socket.on('number_drawn', (data) => {
            clearInterval(rollInterval); // åœæ­¢äº‚è·³
            isRolling = false;
            document.getElementById('current-num').innerText = data.number;
            document.getElementById('draw-btn').disabled = false;
        });

        // 2. æ”¶åˆ°å®Œæ•´å¾Œå°è³‡è¨Šæ›´æ–° (åŒ…å«äººæ•¸ã€æ­·å²ã€æ’è¡Œæ¦œ)
        socket.on('admin_update', (data) => {
            // æ›´æ–°äººæ•¸
            document.getElementById('p-count').innerText = data.count;

            // æ›´æ–°æ­·å²ç´€éŒ„
            const histBox = document.getElementById('history-box');
            histBox.innerHTML = "";
            // åè½‰é™£åˆ—ï¼Œè®“æœ€æ–°çš„åœ¨å‰é¢
            let reversedDrawn = [...data.drawn].reverse();
            reversedDrawn.forEach((num, index) => {
                let div = document.createElement('div');
                div.className = 'hist-ball';
                if(index === 0) div.classList.add('latest'); // æœ€æ–°é‚£é¡†äº®ä¸€é»
                div.innerText = num;
                histBox.appendChild(div);
            });

            // æ›´æ–°æ’è¡Œæ¦œ
            const lb = document.getElementById('leaderboard');
            lb.innerHTML = "";
            
            // ç¯©é¸ï¼šåªé¡¯ç¤ºæœ‰é€²åº¦çš„ç©å®¶ (è½ç‰Œæˆ–Bingo)
            let activePlayers = data.players.filter(p => p.status !== 'NORMAL');
            
            if(activePlayers.length === 0) {
                lb.innerHTML = "<div style='text-align:center; color:#555; margin-top:50px;'>ä¸€åˆ‡é¢¨å¹³æµªéœ...</div>";
            } else {
                activePlayers.forEach(p => {
                    let div = document.createElement('div');
                    div.className = 'lb-row';
                    let statusHtml = "";
                    if(p.status === "REACH") {
                        div.classList.add('lb-reach');
                        statusHtml = "ğŸ”¥ è½ç‰Œ";
                    } else if(p.status === "BINGO") {
                        div.classList.add('lb-bingo');
                        statusHtml = "ğŸ‰ BINGO!";
                    }
                    div.innerHTML = `<span>${p.name}</span><span>${statusHtml}</span>`;
                    lb.appendChild(div);
                });
            }
        });

        // 3. éŠæˆ²çµæŸ (BINGO å½ˆçª—)
        socket.on('game_over', (data) => {
            clearInterval(rollInterval); // ç¢ºä¿å‹•ç•«åœæ­¢
            isRolling = false;
            document.getElementById('draw-btn').disabled = true;
            
            // é¡¯ç¤ºä¸­çè€…
            const screen = document.getElementById('game-over-screen');
            screen.style.display = 'flex';
            document.getElementById('winner-list').innerText = data.winners.join(" & ");
        });

        // 4. é‡ç½®
        socket.on('game_reset', () => {
             location.reload(); // å¾Œå°ç›´æ¥é‡æ•´æœ€ä¹¾æ·¨
        });

    </script>
</body>
</html>
